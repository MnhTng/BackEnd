/*
 *             Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
 *
 *
 *
 *
 *          +---------------------------------------------------------------------------------+
 *          |                                                                                 |
 *          |                                 Hello stranger!                                 |
 *          |                                                                                 |
 *          |                                                                                 |
 *          |   What you're currently looking at is the source code of a legally protected,   |
 *          |    proprietary software. Any attempts to deobfuscate / disassemble this code    |
 *          |               are forbidden and will result in legal consequences.              |
 *          |                                                                                 |
 *          |                                                                                 |
 *          +---------------------------------------------------------------------------------+
 *
 *
 *
 *
 */
import{Command as _0x5a9f4b}from'ckeditor5/src/core.js';import{Range as _0x3c4556}from'ckeditor5/src/engine.js';import{logWarning as _0x19de20,logError as _0x453104,first as _0x1e3268,uid as _0x43c963}from'ckeditor5/src/utils.js';export default class d extends _0x5a9f4b{constructor(_0x277e60){super(_0x277e60),this['set']('isBusy',!0x1),this['_importMarker']=null,this['_undoStepBatch']=null,this['_abortController']=null,this['on']('dataInsert',(_0x42336e,_0x20e7fb)=>{const _0x14e1eb=new DataTransfer();_0x14e1eb['setData']('text/html',_0x20e7fb['html']);const _0x3f2f54=this['_importMarker']['getRange']();this['editor']['model']['enqueueChange'](this['_undoStepBatch'],_0x262e2b=>{this['_importMarker']['stopListening'](),_0x262e2b['setSelection'](_0x3f2f54),_0x277e60['editing']['view']['document']['fire']('clipboardInput',{'dataTransfer':_0x14e1eb});});},{'priority':'low'});}['refresh'](){this['isEnabled']=this['_checkEnabled']();}['execute'](_0x4c897e,_0x4cff65={}){if(this['isBusy'])return Promise['resolve']();const _0x492b87=this['editor']['config']['get']('importWord'),_0x9d0824={'url':_0x492b87['converterUrl'],'file':_0x4c897e,'serviceConfig':{..._0x4cff65,'formatting':_0x492b87['formatting']}};return this['_prepareForImport'](),this['_sendImportRequest'](_0x9d0824)['then'](this['_handleImportResponse']['bind'](this))['catch'](this['_handleImportFailure']['bind'](this))['finally'](this['_cleanUpAfterImport']['bind'](this));}['_checkEnabled'](){if(this['isBusy'])return!0x1;const _0x5c2a9f=this['editor']['model'],_0xf5b4a6=_0x5c2a9f['schema'],_0xc07265=_0x5c2a9f['document']['selection'],_0x45abb1=_0x1e3268(_0xc07265['getSelectedBlocks']());return!!_0x45abb1&&_0xf5b4a6['checkChild'](_0x45abb1['parent'],'paragraph');}['_prepareForImport'](){const _0x3aa187=this['editor'],_0x3cb2bb=_0x3aa187['model'],_0x5a7f9e=_0x3cb2bb['document']['selection'];this['_abortController']=new AbortController(),this['_undoStepBatch']=_0x3aa187['model']['createBatch']({'isUndoable':!0x0}),_0x3cb2bb['enqueueChange'](this['_undoStepBatch'],_0x45e1ce=>{_0x5a7f9e['isCollapsed']||_0x3cb2bb['deleteContent'](_0x5a7f9e,{'leaveUnmerged':!0x0});const _0x227003=_0x5a7f9e['getFirstPosition'](),_0x32cea9=_0x1e3268(_0x5a7f9e['getSelectedBlocks']());let _0x2c9dbb;_0x2c9dbb=_0x32cea9['is']('element','paragraph')&&_0x32cea9['isEmpty']?_0x227003:_0x227003['isAtStart']?_0x3cb2bb['createPositionBefore'](_0x32cea9):_0x227003['isAtEnd']?_0x3cb2bb['createPositionAfter'](_0x32cea9):_0x45e1ce['split'](_0x227003)['position'],this['_importMarker']=_0x45e1ce['addMarker']('importWord:'+_0x43c963(),{'usingOperation':!0x1,'affectsData':!0x1,'range':new _0x3c4556(_0x2c9dbb)}),this['_importMarker']['on']('change:range',()=>{'$graveyard'===this['_importMarker']['getRange']()['root']['rootName']&&this['_abortController']['abort']();});}),this['isBusy']=!0x0,this['refresh']();}['_cleanUpAfterImport'](){const _0x450ed1=this['editor']['model'];_0x450ed1['markers']['has'](this['_importMarker'])&&_0x450ed1['enqueueChange'](this['_undoStepBatch'],_0x2a933a=>{_0x2a933a['removeMarker'](this['_importMarker']);}),this['_importMarker']=null,this['_undoStepBatch']=null,this['_abortController']=null,this['isBusy']=!0x1,this['refresh']();}['_sendImportRequest']({url:_0x48839f,file:_0x237120,serviceConfig:_0x42319e}){const _0xaeacd8=this['editor']['plugins']['get']('ImportWordEditing')['getToken'](),_0x217adf=new FormData();_0x217adf['set']('config',JSON['stringify'](_0x42319e)),_0x217adf['set']('file',_0x237120);const _0x395dab={'method':'POST','headers':{},'body':_0x217adf,'signal':this['_abortController']['signal']};return _0xaeacd8&&(_0x395dab['headers']['Authorization']=_0xaeacd8['value']),fetch(_0x48839f,_0x395dab);}['_handleImportResponse'](_0xb53987){return _0xb53987['ok']?_0xb53987['json']()['then'](_0xf287d0=>{if(!this['editor']['model']['markers']['has'](this['_importMarker']))return;'$graveyard'!==this['_importMarker']['getRange']()['root']['rootName']&&this['fire']('dataInsert',_0xf287d0);}):Promise['reject']();}['_handleImportFailure'](){if(this['_abortController']['signal']['aborted'])return void _0x19de20('import-word-plugin-import-cancelled');const _0x45cea0=this['editor'],_0x5bff19=(0x0,_0x45cea0['t'])('An\x20error\x20occurred\x20while\x20importing\x20the\x20Word\x20file.');_0x45cea0['plugins']['get']('Notification')['showWarning'](_0x5bff19),_0x453104('import-word-plugin-conversion-failed');}}